# تحسين تقرير Rental AI Insights

هذا المستند يوضح الميزات الجديدة، كيفية الاستخدام، وخيارات الفرز التي تمت إضافتها إلى معالج التحليلات الذكية للإيجار.

## نظرة عامة على التحسينات
- تحسين الفلترة:
  - إضافة فلترة حسب العقار (`property_id`).
  - إضافة فلترة حسب المنتج (`product_id`) المرتبط ببنود أوامر التأجير.
  - دعم الجمع بين أكثر من فلتر: الشركة + الفرع + العقار + المنتج + الحساب التحليلي + العميل + رقم العقد + الفترة الزمنية.
- توسيع البيانات المعروضة:
  - إضافة عمود "رقم عقد التوصيل" ضمن تقرير العقود، يتم جلبه من أوامر التوصيل المرتبطة (Stock Picking) عبر الحقل `tender_contract_id` إن وجد، أو استخدام اسم العقد كبديل.
- تحسين العرض التحليلي:
  - التأكد من توافق الأعمدة الجديدة مع تحليلات الذكاء الاصطناعي.
  - السماح بفرز النتائج حسب: العقار، رقم العقد، أو المنتج عبر الحقل `sort_by`.

## كيفية الاستخدام
1. من القائمة: "تحليلات الذكاء الاصطناعي" افتح معالج "Rental AI Insights".
2. ضمن مجموعة "معايير التحليل":
   - اختر الشركة والفرع حسب الحاجة.
   - اختر عقارًا لتقييد النتائج على هذا العقار.
   - اختر منتجًا (الوحدة المؤجرة) لفلترة العقود والفواتير حسب هذا المنتج.
   - يمكنك أيضًا تحديد الحساب التحليلي والعميل.
   - إذا رغبت بالبحث برقم العقد، أدخل رقم عقد أمر البيع في حقل "رقم العقد".
   - حدد فترة التاريخ: "تاريخ الاستلام" و"تاريخ التسليم" لعرض العقود التي تتداخل مع هذه الفترة.
   - اختر طريقة الفرز من قائمة "ترتيب حسب": العقار أو رقم العقد أو المنتج.
3. اضغط زر "تحليل" لعرض النتائج:
   - صفحة "ملخص" تعرض مؤشرات مالية عامة (عدد الفواتير، المسدد، المستحق، الإيرادات، المصروفات).
   - صفحة "مقارنة سنوية" للمقارنة بين الإيرادات والمصروفات سنويًا.
   - صفحة "توقعات AI" لعرض توقع الإيرادات للأشهر الثلاثة القادمة.
   - صفحة "تقرير العقود" تعرض الجدول التفصيلي بما في ذلك عمود "رقم عقد التوصيل".
   - صفحة "توقعات العقار" تظهر التوقعات عندما يتم اختيار عقار.

## الفرز (sort_by)
- `property`: يرتب حسب العقار.
- `contract`: يرتب حسب رقم عقد أمر البيع (`order_id.name`).
- `product`: يرتب حسب المنتج (الوحدة المؤجرة).

## مصادر البيانات والربط
- الفواتير (عميل):
  - فلترة العقار عبر الحقل `account.move.property_name`.
  - فلترة المنتج عبر `account.move.invoice_line_ids.product_id`.
  - فلترة رقم العقد عبر `account.move.so_contract_number` (مرتبط بـ `sale.order.contract_number`).
- المصروفات (مورد):
  - فلترة المنتج عبر `account.move.invoice_line_ids.product_id`.
  - فلترة الحساب التحليلي بمطابقة خطوط الفاتورة مع `analytic_account_id`.
- العقود (بنود أمر البيع `sale.order.line`):
  - فلترة الشركة والفرع والحساب التحليلي والعميل.
  - تاريخ التداخل: `fromdate <= تاريخ التسليم` و `todate >= تاريخ الاستلام`.
  - الربط مع أوامر التوصيل (Stock Picking) عبر `origin = sale.order.name` لاستخراج "رقم عقد التوصيل" من `tender_contract_id.ref` أو `tender_contract_id.name`.

## المتطلبات
- وجود الحقل `property_name` على `account.move` من إضافة `renting`.
- وجود الحقل `so_contract_number` على `account.move` من إضافة `renting`.
- لإظهار "رقم عقد التوصيل" يفضل وجود إضافة `contracts_management` التي تُعرِّف الحقل `tender_contract_id` على `stock.picking`.

## ملاحظات الأداء
- يتم استخدام ذاكرة مؤقتة (Cache) أثناء توليد تقرير العقود لتقليل عمليات البحث المتكررة عن أوامر التوصيل لكل أمر بيع.

## التحديث والترقية
- بعد تثبيت التغييرات، حدّث تطبيق "Rental AI Insights":
  - من قائمة التطبيقات: قم بترقية الوحدة `rental_ai_insights`.
  - أو من واجهة المطور: تفعيل وضع المطور ثم تحديث:
    - التطبيقات > تحديث قائمة التطبيقات، ثم ترقية الوحدة.

## قيود معروفة
- إذا لم تكن هناك أوامر توصيل مرتبطة بأمر البيع، سيظهر عمود "رقم عقد التوصيل" فارغًا.
- إذا لم تكن إضافة `contracts_management` مثبتة، قد لا يتوفر `tender_contract_id` ويستخدم النظام بديلًا من اسم العقد إن وجد.